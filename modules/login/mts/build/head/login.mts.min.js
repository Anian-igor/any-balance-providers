var g_baseurlLogin="https://login.mts.ru";
function checkLoginError(a,c){function d(a){var b=sumParam(a,/var\s+(?:passwordErr|loginErr)\s*=\s*'([^']*)/g,replaceSlashes,null,aggregate_join);b||(b=getElement(a,/<[^>]+field-help/i,replaceTagsAndSpaces));if(b)throw new AnyBalance.Error(b,null,/логин|парол/i.test(b));if(b=getElement(a,/<div[^>]+b-page_error__msg[^>]*>/,replaceTagsAndSpaces))throw new AnyBalance.Error(b);}var e=AnyBalance.getPreferences();d(a);var b=getElement(a,/<[^>]+captcha-wrapper/i);b&&(b=getParam(b,/data:image\/\w+;base64,([^'"]+)/i,
replaceHtmlEntities));b&&0<=b.indexOf("iVBORw0KGgoAAAANSUhEUgAAANMAAAA6CAIAAAClLvvEAAAeQElEQVR42u3de7yVVZkH8NTQSi3N7uUltQuaoGFp")&&(AnyBalance.trace("Капча спрятана. Ищем её в другом месте"),b=null);b||(b=getParam(a,/#captcha-wrapper\s*\{[^\}]*/));b&&(b=getParam(b,/data:image\/\w+;base64,([^'"]+)/i));if(b){AnyBalance.trace("МТС решило показать капчу :( Жаль");var f=AnyBalance.retrieveCode("МТС требует ввести капчу для входа в личный кабинет, чтобы подтвердить, что вы не робот. Введите символы, которые вы видите на картинке.",
b);a=getElement(a,/<form[^>]+name="Login"/i);b=createFormParams(a,function(a,b,d,c){if("IDToken1"==d||"IDToken2"==d)c=e.password;return c});AnyBalance.trace("Логинимся с заданным номером и капчей");a=AnyBalance.requestPost(c,b,addHeaders({Origin:g_baseurlLogin,Referer:c}));fixCookies();500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),a=AnyBalance.requestPost(c,b,addHeaders({Origin:g_baseurlLogin,Referer:c})),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",
allowRetry);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&d(a)}else if(/МТС\s*-\s*Установка пароля/i.test(a)){AnyBalance.trace("МТС потребовало установить пароль. Установим старый");a=getElement(a,/<form[^>]+name="Login"/i);b=createFormParams(a,function(a,b,d,c){"IDToken2"==d&&(c=f);return c});a=AnyBalance.requestPost(c,b,addHeaders({Origin:g_baseurlLogin,Referer:c}));fixCookies();if(/Ваш пароль успешно/i.test(a))throw AnyBalance.trace(a),new AnyBalance.Error("МТС потребовала установить новый пароль, автоматическая установка старого не удалась. Сайт изменен?");
a=getElement(a,/<form[^>]+name="Login"/i);b=createFormParams(a);a=AnyBalance.requestPost(c,b,addHeaders({Origin:g_baseurlLogin,Referer:c}));fixCookies()}else throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти капчу. Сайт изменен?");return a}
function redirectIfNeeded(a){if(/<body[^>]+onload[^>]+submit/i.test(a)){AnyBalance.trace("Потребовался редирект формой...");var c=createFormParams(a),d=getParam(a,/<form[^>]+action=['"]([^'"]*)/,replaceHtmlEntities);a=AnyBalance.getLastUrl();a=AnyBalance.requestPost(joinUrl(a,d),c,addHeaders({Refefer:a}));fixCookies()}if(c=getParam(a,/<meta[^>]+http-equiv="REFRESH"[^>]*content="0;url=([^";]*)/i,replaceHtmlEntities))AnyBalance.trace("Потребовался get редирект..."),a=AnyBalance.getLastUrl(),a=AnyBalance.requestGet(joinUrl(a,
c),addHeaders({Refefer:a})),fixCookies();return a}function isOnLogin(){return 0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)}
function enterMtsLK(a){var c=a.url||g_baseurlLogin,d=AnyBalance.requestGet(c,g_headers);fixCookies()&&(AnyBalance.trace("Куки исправлены на входе..."),d=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers),fixCookies());500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),d=AnyBalance.requestGet(c,g_headers),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...");
/Произошла ошибка при попытке авторизации/i.test(d)&&(AnyBalance.trace("Куки протухли :( Придется авторизоваться заново"),clearAllCookies(),d=AnyBalance.requestGet(c,g_headers),fixCookies());fixCookies()&&(AnyBalance.trace("Куки исправлены, перезагружаем страницу. Пробуем ещё разок..."),d=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers),fixCookies());d=redirectIfNeeded(d);if(c=getElement(d,/<[^>]+login-form__confirm-number/i,[replaceTagsAndSpaces,/\D+/g,""])){AnyBalance.trace("Предлагает автоматически залогиниться на "+
c);var d=getElement(d,/<form[^>]+name="Login"/i),e;c&&endsWith(c,a.login)?(AnyBalance.trace("А нам этот номер и нужен. Соглашаемся..."),e="Login"):(AnyBalance.trace("А нам нужен номер "+a.login+". Отказываемся..."),e="Ignore");d=createFormParams(d,function(a,d,c,g){"IDButton"==c&&(g=e);return g});d=AnyBalance.requestPost(AnyBalance.getLastUrl(),d,addHeaders({Referer:AnyBalance.getLastUrl()}));fixCookies()}isOnLogin()?(a.html=d,a.url||(a.url=AnyBalance.getLastUrl()),d=enterMTS(a)):AnyBalance.trace("Мы не на странице логина. Внутри уже?");
if(isOnLogin())throw AnyBalance.trace(d),new AnyBalance.Error("Не удаётся зайти в личный кабинет");return d}
function fixCookies(){for(var a=AnyBalance.getCookies(),c=!1,d=0;d<a.length;++d){var e=a[d];/^login|REDIRECT_BACK_SERVER_URL$/i.test(e.name)&&!/^"/.test(e.value)&&(c='"'+e.value+'"',AnyBalance.trace("Исправляем куки "+e.name+" на "+c),AnyBalance.setCookie(e.domain,e.name,c,e),c=!0)}AnyBalance.getCookie("login")||AnyBalance.setCookie("login.mts.ru","login",'"https://login.mts.ru:443/amserver/UI/Login?service=newlk&goto=http%3A%2F%2Flk.mts.ru%2F"',{path:"/amserver/UI/Login"});return c}
function saveLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.setData("login",a.login+"-v1");AnyBalance.saveCookies();AnyBalance.saveData()}function restoreLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.getData("login")===a.login+"-v1"&&AnyBalance.restoreCookies()}
function enterMTS(a){var c=a.baseurl||g_baseurl,d=a.url||g_baseurlLogin+"/amserver/UI/Login?goto="+c,e=a.allowRetry,b=a.html;fixCookies();if(!b||!/<form[^>]+name="Login"/i.test(b))if(b=AnyBalance.requestGet(d,g_headers),fixCookies(),500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),b=AnyBalance.requestGet(d,g_headers),fixCookies()),500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...",
e);if(0==AnyBalance.getLastUrl().indexOf(c))return b;var b=redirectIfNeeded(b),f;if(f=getElement(b,/<form[^>]+name="Login"/i)){AnyBalance.trace("Найдена обычная форма входа");c=createFormParams(f,function(b,d,c,e){"IDToken1"==c?e=a.login:"IDToken2"==c?e=a.password:"noscript"==c?e=void 0:"IDButton"==c&&(e="Submit");return e});if(b=getParam(f,/data-sitekey="([^"]*)/i,replaceHtmlEntities))AnyBalance.trace("МТС требует рекапчу :("),b=solveRecaptcha("МТС требует ввода рекапчи, как и при входе через браузер. Пожалуйста, докажите, что вы не робот.",
d,b),c.IDToken3=b;AnyBalance.trace("Логинимся с заданным номером");b=AnyBalance.requestPost(d,c,addHeaders({Origin:g_baseurlLogin,Referer:d}));fixCookies()}else if(f=getElement(b,/<form[^>]+id="login-phone-form"/i)){AnyBalance.trace("Найдена корп. форма входа");c=createFormParams(f,function(b,c,d,e){"IDToken1"==d&&(e=a.login);return e});b=AnyBalance.requestPost(d,c,addHeaders({Origin:g_baseurlLogin,Referer:d}));fixCookies();f=getElement(b,/<form[^>]+id="enter-password-form"/i);if(!f){if(d=getElement(b,
/<[^>]+intro-text/i,replaceTagsAndSpaces))throw new AnyBalance.Error(d,null,/не существует/i.test(d));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось найти форму ввода пароля. Сайт изменен?");}c=createFormParams(f,function(b,d,c,e){"IDToken1"==c?e=a.login:"IDToken2"==c&&(e=a.password);return e});b=AnyBalance.requestPost(d,c,addHeaders({Origin:g_baseurlLogin,Referer:d}));fixCookies()}else{if(!b)throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже");
if(/<h1[^>]*>\s*Request Error/i.test(b))throw new AnyBalance.Error("Личный кабинет МТС временно не работает. Попробуйте ещё раз позже");AnyBalance.trace(b);throw new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?",e);}500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),b=AnyBalance.requestPost(d,c,addHeaders({Origin:g_baseurlLogin,Referer:d})),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",
e);isOnLogin()&&(b=checkLoginError(b,d));if(isOnLogin())throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",e);return b};
